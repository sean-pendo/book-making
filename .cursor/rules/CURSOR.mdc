---
description: Master context for the Book Builder project, including architecture, QA state, and critical debugging rules.
globs: **/*
---
# Project Context: Book Builder (QA Phase)

## 1. Project Overview
**Book Builder** is a territory balancing and assignment tool for Sales Operations. It allows RevOps to import data (Accounts, Reps), define rules, and generate fair account assignments based on ARR, geography, and other metrics.

## 2. Tech Stack
- **Frontend**: React (Vite), TypeScript, Shadcn UI, Tailwind CSS.
- **Backend**: Supabase (PostgreSQL, Edge Functions).
- **State Management**: TanStack Query (React Query).
- **Persistence**: `localStorage` (for import state) + Supabase (for data).

## 3. Business Logic Documentation

### ğŸ“š SINGLE SOURCE OF TRUTH: `src/_domain/`

**The `_domain/` folder is the authoritative source for ALL business logic.**

| File | Purpose |
|------|---------|
| **`MASTER_LOGIC.mdc`** | Human-readable documentation of all business rules |
| **`calculations.ts`** | ARR, ATR, Pipeline calculations |
| **`tiers.ts`** | Team tier (SMB/Growth/MM/ENT) classification |
| **`geography.ts`** | Region hierarchy, territory mapping, geo scoring |
| **`constants.ts`** | Thresholds, defaults, configuration values |
| **`normalization.ts`** | Typo handling and data normalization |

### âœ… What BELONGS in `_domain/` (Business Logic)
- **Calculations**: How ARR, ATR, Pipeline values are computed
- **Classification rules**: Tier thresholds, account categorization
- **Geography rules**: Region hierarchy, territory mapping logic
- **Constants**: Threshold values, scoring weights, defaults
- **Normalization**: Data cleanup (region aliases, typos)
- **Display logic rules**: When to show Sales Tools, how to format priority labels
- **Solver parameters**: LP penalty values, scale limits, normalization strategies

### âŒ What does NOT belong in `_domain/`
- React components (`*.tsx` with JSX)
- Hooks (`useXxx`)
- Services (API calls, Supabase queries)
- UI state management
- Contexts (`AuthContext`, etc.)
- Formatting helpers (currency display, date formatting)

**Rule**: `_domain/` answers "HOW should the app calculate/classify things?"
It does NOT answer "HOW should the app render/fetch/store things?"

---

## ğŸš¨ SSOT FLOW - CRITICAL ENFORCEMENT

### âš ï¸ THE SSOT FLOW (Single Source of Truth)

> **THIS IS THE MOST IMPORTANT RULE IN THE CODEBASE.**
> Every business logic change MUST follow this exact order. No exceptions.

**When adding or editing ANY reusable business logic, ALWAYS follow this order:**

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: MASTER_LOGIC.mdc  â†’  Document the rule/formula FIRST  â”‚
â”‚  STEP 2: _domain/*.ts      â†’  Implement in the appropriate file â”‚
â”‚  STEP 3: Consumer files    â†’  Import from @/_domain and use     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

**This flow is NON-NEGOTIABLE.** Never skip steps or go out of order.

### ğŸ“‹ SSOT Pre-Implementation Checklist

**Before writing ANY business logic code, answer these questions:**

- [ ] **Is this business logic?** (calculations, thresholds, classification rules, display rules)
- [ ] **Have I documented it in `MASTER_LOGIC.mdc` first?** (with section number like Â§12.1.1)
- [ ] **Does a function/constant already exist in `_domain/`?** (check before creating new)
- [ ] **Am I importing from `@/_domain`?** (never inline the logic)

### ğŸ“ SSOT Implementation Steps

| Step | Action | Example | Verify |
|------|--------|---------|--------|
| **1. Document** | Add/update in `MASTER_LOGIC.mdc` | "Â§12.1.1 Balance Max = MAX(avg Ã— 1.5, largest Ã— 1.2)" | Can find it by section number |
| **2. Implement** | Add function/constant to `_domain/*.ts` | `export function calculateBalanceMax(...)` | Has `@see MASTER_LOGIC.mdc Â§X.X` JSDoc |
| **3. Export** | Ensure exported from `_domain/index.ts` | Auto-exports via `export * from './constants'` | Can import from `@/_domain` |
| **4. Import** | Use in components/services/hooks | `import { calculateBalanceMax } from '@/_domain'` | No inline logic in consumer |

### ğŸ·ï¸ SSOT Changelog Labeling

**When you follow the SSOT flow, prefix your changelog entry with `SSOT:`**

\`\`\`markdown
## [2025-12-16] - SSOT: New Balance Threshold Calculation

**Changes:**
1. **Updated MASTER_LOGIC.mdc Â§12.1.1** - Documented new balance max formula
2. **Added to _domain/constants.ts** - `calculateBalanceMax()` function
3. **Updated consumers** - FullAssignmentConfig.tsx now imports from @/_domain
\`\`\`

This makes SSOT compliance **visible and auditable** in the changelog.

### âœ… SSOT Compliance Examples

**GOOD - Full SSOT Flow:**
\`\`\`
1. Add to MASTER_LOGIC.mdc Â§11.3: "LP_PENALTY.ALPHA = 0.001 for variance band"
2. Add to constants.ts: export const LP_PENALTY = { ALPHA: 0.001, ... }
3. Import in lpProblemBuilder.ts: import { LP_PENALTY } from '@/_domain'
\`\`\`

**BAD - Skipped Documentation:**
\`\`\`
1. âŒ Skipped MASTER_LOGIC.mdc
2. Added to lpProblemBuilder.ts: const PENALTY = 0.001  // inline magic number!
\`\`\`

**BAD - Wrong Order:**
\`\`\`
1. âŒ Implemented in constants.ts first
2. âŒ Then documented in MASTER_LOGIC.mdc after
   (This causes docs to drift from reality)
\`\`\`

### ğŸ”´ SSOT Violations to Watch For

| Violation | Example | Fix |
|-----------|---------|-----|
| **Magic numbers** | `if (arr < 25000)` | Use `SALES_TOOLS_ARR_THRESHOLD` from `@/_domain` |
| **Inline calculations** | `account.calculated_arr \|\| account.arr \|\| 0` | Use `getAccountARR(account)` from `@/_domain` |
| **Undocumented constants** | `const MAX_ACCOUNTS = 3000` in service file | Add to `MASTER_LOGIC.mdc`, then `constants.ts` |
| **Duplicate logic** | Same formula in 2+ files | Consolidate to `_domain/*.ts`, import everywhere |
| **Bug fixes without docs** | Fix a calculation but don't update docs | Always update `MASTER_LOGIC.mdc` first |

### ğŸ›‘ STOP AND ASK Before Proceeding

**If you're about to add business logic and haven't updated `MASTER_LOGIC.mdc` first, STOP.**

Ask yourself:
1. "What section of MASTER_LOGIC.mdc does this belong in?"
2. "What's the formula/rule I'm implementing?"
3. "Is there an existing constant/function I should use instead?"

**If unsure, ASK THE USER before implementing.**

---

### ğŸ”’ MANDATORY RULES

1. **Always import from `@/_domain`** - Never hardcode business logic elsewhere
   \`\`\`typescript
   // âœ… CORRECT
   import { getAccountARR, classifyTeamTier, REGION_HIERARCHY } from '@/_domain';
   
   // âŒ WRONG - inline logic
   const arr = account.calculated_arr || account.arr || 0;
   \`\`\`

2. **Paired updates required** - When changing business logic:
   - Update `MASTER_LOGIC.mdc` (documentation) **FIRST**
   - Update the corresponding `.ts` file (implementation)
   - Both must stay in sync

3. **Never create duplicate logic** - If you find business logic outside `_domain/`:
   - Flag it to the user
   - Refactor to import from `@/_domain`

4. **Standardized Consolidation Technique** - When consolidating code:
   - `_domain/` = **DEFINITIONS** (source of truth)
   - `utils/`, `components/`, `services/`, `hooks/` = **CONSUMERS**
   - **Don't MOVE files** between folders. Refactor them to IMPORT from `@/_domain`
   - Keep utils in utils, components in components, etc.

### ğŸ” Gradual Refactoring Rule

When working on ANY file in the codebase:

1. **Detect Hardcoded Logic**: Look for inline calculations that should use `@/_domain`:
   - ARR calculations (priority chains like `calculated_arr || arr || 0`)
   - ATR calculations (filtering by `opportunity_type = 'Renewals'`)
   - Tier thresholds (magic numbers like `100`, `500`, `1500`)
   - Region/territory mappings
   - PE firm name handling
   - LP solver parameters (penalties, scale limits)
   - Display rules (when to show/hide UI elements based on business state)

2. **Flag Discrepancies**: If you find hardcoded logic that **differs** from `src/_domain/`:
   - **STOP and ASK the user** before changing anything
   - Example: "I found `employees < 150` for SMB in this file, but `TIER_THRESHOLDS.SMB_MAX` is 99. Which is correct?"

3. **Propose Refactor**: If the hardcoded logic **matches** `src/_domain/`:
   - Suggest replacing with the import
   - Example: "This file has inline ARR calculation. Want me to refactor to use `getAccountARR()` from `@/_domain`?"

4. **Never Silently Change**: Business logic discrepancies may be intentional edge cases. Always confirm with user.

**Questions to Ask When Discrepancy Found:**
- "Is this intentional or a bug?"
- "Should we update `MASTER_LOGIC.mdc` and `src/_domain/` to match this, or vice versa?"
- "Is this an exception for this specific use case?"
- "Should we add this as a new constant/function in the _domain module?"

## 4. Architecture & System Map
### Data Pipeline
1.  **Import**: `DataImport.tsx` -> `BatchImportService.ts` -> Supabase.
    *   *Note*: Uses "Optimized Import" which deletes existing records before inserting. High risk of data loss if insert fails.
2.  **Storage**: Core tables are `accounts`, `sales_reps`, `assignments`, `assignment_rules`.

### Assignment Engine
Multiple services exist for different use cases:
1.  **`simplifiedAssignmentEngine.ts`**: Primary engine with priority waterfall
2.  **`rebalancingAssignmentService.ts`**: Multi-pass rebalancing
3.  **`enhancedAssignmentService.ts`**: Enhanced balancing features
4.  **`optimization/`**: HiGHS LP solver for optimal assignments

All engines import business logic from `@/_domain`.

## 5. QA Status (v1.3+)
Codebase has been stabilized and consolidated. Business logic is centralized in `_domain/`.

### Recent Improvements (v1.3.x)
*   **Domain Consolidation**: All business logic in `src/_domain/`
*   **Dead Code Removal**: ~4,000 lines of dead code removed
*   **Unified Scoring**: Analytics and engine use same scoring weights
*   **Documentation**: MASTER_LOGIC.mdc is comprehensive and audited

### Debugging Strategy
1.  **Check `_domain/`**: All business logic should come from here
2.  **Verify Supabase**: If data looks wrong, check the DB first
3.  **Console Logs**: Assignment engine logs to console with `[AssignmentEngine]` prefix

### ğŸ”´ Debug Mode Requirements

**When entering Debug Mode, ALWAYS start by reviewing business logic:**

1. **Read `src/_domain/MASTER_LOGIC.mdc`** - Understand the expected behavior before investigating
2. **Check relevant `_domain/*.ts` files** - Verify the implementation matches documentation
3. **Compare actual vs expected** - Use `MASTER_LOGIC.mdc` as the source of truth for what *should* happen

**Debug Mode Checklist:**
- [ ] Did I read `MASTER_LOGIC.mdc` to understand the business rule?
- [ ] Is the bug in the business logic (fix `_domain/`) or in a consumer (fix component/service)?
- [ ] Does the current implementation match the documented behavior?
- [ ] If there's a discrepancy, which is correct - the docs or the code?

**Why this matters:** Many bugs are business logic misunderstandings, not code errors. Reading the docs first prevents "fixing" code that's actually correct.

## 6. Rules & Guidelines

### ğŸ“œ Documentation Rules
*   **Structure**:
    *   `docs/core/`: Strategy & Architecture (e.g., `architecture.md`).
    *   `docs/archive/`: Historical plans and resolved issues.
    *   `src/_domain/MASTER_LOGIC.mdc`: Business logic documentation (primary reference).
*   **Docs First**: Update `MASTER_LOGIC.mdc` or `docs/core/architecture.md` before complex changes.
*   **Changelog Maintenance**: **MANDATORY**. You must maintain a `CHANGELOG.md` file in the root.
    *   Every time you make a code change (fix, feature, refactor), you must append an entry to `CHANGELOG.md`.
    *   Format: `[YYYY-MM-DD] - {Type}: {Description}`.
    *   Types: `Fix`, `Feature`, `Refactor`, `Docs`.
*   **Simple Language**: Use clear, non-jargon English in comments and docs.

### ğŸ›¡ï¸ Safety & Coding
*   **File Operations**: Always check if a file exists before creation. Prefer `edit` over `overwrite`.
*   **No Magic**: Do not assume deployment environments. Check env vars first.
*   **Browser Tools**: Only use browser/testing tools (navigate, snapshot, click, screenshot, etc.) when the user **explicitly asks** to test in the browser or view the app. Do NOT proactively open browser tabs or test features without being asked.
*   **Pre-Deploy Code Review**: **MANDATORY**. Before deploying ANY change to Vercel:
    1. Re-read the code you modified to verify it makes sense
    2. Check for edge cases (null values, empty arrays, race conditions)
    3. Verify the change doesn't break related flows (e.g., if you change approval logic, check ALL approval paths)
    4. Look for missing error handling
    5. Ensure notifications go to the right people
    6. Run linter checks on modified files

## 7. Versioning & Releases

### Version Display
The app version is shown in **Settings** at the bottom. It pulls from `package.json` at build time.

### Release Workflow (AI-Assisted)
**Proactive releases**: After significant changes (3+ features/fixes, or end of session), suggest a patch release (e.g., 1.1.1 â†’ 1.1.2).

When the user says "release", "push to GitHub", or "create a version", follow this process:

1. **Bump version** in `book-ops-workbench/package.json`
   - Patch (x.x.1): Bug fixes only
   - Minor (x.1.0): New features
   - Major (1.0.0): Breaking changes

2. **Update CHANGELOG.md** with all changes since last release

3. **Run these commands** (requires git_write permission):
   \`\`\`bash
   cd "/Users/sean.muse/code/book building v1.0 QA"
   git add -A
   git commit -m "Release vX.X.X - <summary>"
   git tag vX.X.X
   git push origin master --tags
   \`\`\`

4. **Deploy to Vercel** (if not already done)

### Current Version
Check `book-ops-workbench/package.json` for the current version number.

## 8. Git & GitHub

### When to Push
Push to GitHub when:
- A feature is complete and tested
- User explicitly requests a release
- Before ending a long session with significant changes

### Commit Message Format
`Release vX.X.X - Brief summary` for releases
`Fix: description` or `Feature: description` for regular commits

## 9. Developer & Notifications

### Developer Info
- **Developer Slack**: `@sean.muse` (pendo.io workspace)
- **Developer Email**: `sean.muse@pendo.io`
- All developer feedback, error notifications, and fallback messages go to @sean.muse

### Slack Notification Routing
- **pendo.io emails** â†’ DM to user (extracted from email prefix)
- **Non-pendo.io emails** â†’ Fallback DM to @sean.muse with context
- **Feedback widget** â†’ Always DMs @sean.muse
- **Error reports** â†’ Always DMs @sean.muse (includes stack traces)

### Error Reporting
The app has global error handlers that automatically send errors to Slack:
- Uncaught JavaScript errors
- Unhandled Promise rejections
- React Error Boundary catches
All errors include: stack trace, URL, user agent, app version, timestamp.

### Supabase Project
- **Project ID**: `lolnbotrdamhukdrrsmh`
- **Edge Functions**: `send-slack-notification`, `gemini-territory-mapping`, etc.
- **Required Secret**: `SLACK_BOT_TOKEN` - Must be set in Supabase Dashboard â†’ Settings â†’ Edge Functions for Slack notifications to work

### Vercel Deployment
- **Account**: `seanxmuses-projects` (personal Vercel - CLI deployments only)
- **Project**: `book-ops-workbench`
- **Production URL**: `https://book-ops-workbench-eosin.vercel.app`
- **Beta URL (v1.2)**: `https://book-ops-v1-2-beta.vercel.app` (pinned deployment for beta testers)
- **Deploy Command**: `vercel --prod` (from `book-ops-workbench` directory)
- **Environment Variables**: `VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`

**Note**: Beta URL requires Deployment Protection to be disabled in Vercel Settings for public access.

### GitHub (Separate from Vercel)
- **Repo**: `https://github.com/sean-pendo/book-making` (work GitHub)
- **Purpose**: Version control only - NOT connected to Vercel
- **Push Command**: `git push origin master`

**Important**: GitHub and Vercel are intentionally separate. Push to GitHub for version control, use `vercel --prod` CLI for deployments.

## 10. Terminology & Glossary

> **Full Reference**: See [`src/_domain/MASTER_LOGIC.mdc`](../../book-ops-workbench/src/_domain/MASTER_LOGIC.mdc) for complete glossary with calculation formulas.

### Quick Reference

| Term | Meaning |
|------|---------|
| **ARR** | Annual Recurring Revenue (customers only) |
| **ATR** | Available to Renew - revenue timing, NOT risk |
| **Pipeline** | Prospect opportunity value (`net_arr`) |
| **CRE** | Customer Renewal at Risk - churn indicator |
| **Team Tier** | SMB/Growth/MM/ENT based on employee count |

### Key Calculation Rules

\`\`\`
ARR Priority:  hierarchy_bookings_arr_converted â†’ calculated_arr â†’ arr â†’ 0
               (hierarchy_bookings first to prevent double-counting from children)
ATR Source:    SUM(available_to_renew) WHERE opportunity_type = 'Renewals'
Team Tier:     SMB (<100 emp) | Growth (100-499) | MM (500-1499) | ENT (1500+) | null (unknown)
\`\`\`

## 11. Learning Log
Maintain a learning log so as we build this app I continue to understand what we are doing, and why
