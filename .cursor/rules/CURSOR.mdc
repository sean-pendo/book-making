---
description: Master context for the Book Builder project, including architecture, QA state, and critical debugging rules.
globs: **/*
---
# Project Context: Book Builder (QA Phase)

## 1. Project Overview
**Book Builder** is a territory balancing and assignment tool for Sales Operations. It allows RevOps to import data (Accounts, Reps), define rules, and generate fair account assignments based on ARR, geography, and other metrics.

## 2. Tech Stack
- **Frontend**: React (Vite), TypeScript, Shadcn UI, Tailwind CSS.
- **Backend**: Supabase (PostgreSQL, Edge Functions).
- **State Management**: TanStack Query (React Query).
- **Persistence**: `localStorage` (for import state) + Supabase (for data).

## 3. Architecture & System Map
### Data Pipeline
1.  **Import**: `DataImport.tsx` -> `BatchImportService.ts` -> Supabase.
    *   *Note*: Uses "Optimized Import" which deletes existing records before inserting. High risk of data loss if insert fails.
2.  **Storage**: Core tables are `accounts`, `sales_reps`, `assignments`, `assignment_rules`.

### Assignment Engine
Multiple services exist (fragmentation risk). Always verify which is active:
1.  **`RebalancingAssignmentService.ts`**: The main/modern engine ("Complete Overhaul").
2.  **`CollaborativeAssignmentService.ts`**: Rule-based legacy engine.
3.  **`SophisticatedAssignmentService.ts`**: Multi-pass legacy engine.

## 4. QA Status & Known Issues (v1.0)
We are currently in **QA Mode**. The codebase is unstable.

### Critical Blockers
*   **Generation Flow**: Assignments fail to generate or return blank results.
*   **Data Import**: Users see "0 Accounts" after import until hard refresh. State sync issue between React <-> Supabase.

### Debugging Strategy
1.  **Trust Nothing**: Verify data in Supabase first. If it's not in the DB, the UI is lying.
2.  **Isolate Flow**: When fixing Generation, check `RebalancingAssignmentService` logs first.
3.  **Local Dev**: Debug locally with a connected Supabase instance to reproduce "0 Accounts" bug.

## 5. Rules & Guidelines

### üìú Documentation Rules
*   **Structure**:
    *   `docs/core/`: Strategy & Architecture (e.g., `architecture.md`).
    *   `docs/ops/`: QA & Operations (e.g., `qa_log.md`).
*   **Docs First**: Update `docs/ops/qa_log.md` or `docs/core/architecture.md` before complex changes.
*   **Changelog Maintenance**: **MANDATORY**. You must maintain a `CHANGELOG.md` file in the root.
    *   Every time you make a code change (fix, feature, refactor), you must append an entry to `CHANGELOG.md`.
    *   Format: `[YYYY-MM-DD] - {Type}: {Description}`.
    *   Types: `Fix`, `Feature`, `Refactor`, `Docs`.
*   **Simple Language**: Use clear, non-jargon English in comments and docs.

### üõ°Ô∏è Safety & Coding
*   **File Operations**: Always check if a file exists before creation. Prefer `edit` over `overwrite`.
*   **No Magic**: Do not assume deployment environments. Check env vars first.
*   

## 6. Git Suggestions
This is a very important project when the time is approriate. Please let me know when I should push updates to GitHub


## 7. Learning Log
Maintain a learning log so as we build this app I continune to understand what we are doing, and why