# Book Builder - Business Logic & System Reference

> **Version**: 1.3.7  
> **Last Updated**: 2025-12-15  
> **Status**: ACTIVE - Audited and consolidated  
> **Purpose**: Single source of truth (SSOT) for all business rules

**Why SSOT?** This document + the `_domain/*.ts` files are the authoritative source for all business logic. No magic numbers scattered across components. When you need to know "how is ARR calculated?" or "what makes an account Enterprise?" - look here first, not in random component files.

---

## Quick Reference

<details>
<summary><strong>ğŸ“Š Key Formulas (click to expand)</strong></summary>

| Calculation | Formula | Source |
|-------------|---------|--------|
| ARR | `hierarchy_bookings_arr_converted âˆ¥ calculated_arr âˆ¥ arr âˆ¥ 0` | Â§2.1 |
| ATR | `SUM(opps.available_to_renew) WHERE type='Renewals'` | Â§2.2 |
| Pipeline | `SUM(opps.net_arr) WHERE is_customer=false OR type='Expansion'` | Â§2.3 |
| Team Tier | `employees < 100 â†’ SMB, < 500 â†’ Growth, < 1500 â†’ MM, else ENT` | Â§5.1 |
| Geo Score | `exact=1.0, sibling=0.85, parent=0.65, global=0.40, cross=0.20` | Â§4.3 |
| Balance Target | `Total Value / Number of Active Reps` | Â§12.1 |

</details>

<details>
<summary><strong>ğŸ”¢ Key Thresholds (click to expand)</strong></summary>

| Threshold | Value | Purpose |
|-----------|-------|---------|
| Sales Tools ARR | $25,000 | Below this â†’ Sales Tools bucket |
| High Value ARR | $100,000 | Legacy default - threshold for high-value metrics |
| High Value Continuity | $500,000 | Legacy default - threshold for continuity metrics |
| Max ARR per Rep | $2,500,000 | Default capacity cap (configurable) |
| Overload Variance | 20% | Default variance from target before rep is overloaded (configurable) |
| Stability Days | 90 | Renewal soon / recent change window |
| Strategic Variance | 20% | Balance variance for strategic accounts |

</details>

<details>
<summary><strong>ğŸ“ File Quick Reference (click to expand)</strong></summary>

| File | Purpose |
|------|---------|
| `calculations.ts` | ARR, ATR, Pipeline formulas |
| `tiers.ts` | Team tier classification |
| `geography.ts` | Region hierarchy, geo scoring |
| `normalization.ts` | Typo handling for imports |
| `constants.ts` | All thresholds and defaults |

</details>

---

## Table of Contents

### Part 1: Core Business Definitions
1. [Glossary & Terminology](#1-glossary--terminology)
2. [Revenue Metrics](#2-revenue-metrics)
3. [Account Classification](#3-account-classification)
4. [Geography & Territories](#4-geography--territories)
5. [Team Tiers](#5-team-tiers)
6. [Data Normalization](#6-data-normalization)

### Part 2: Organizational Structure
7. [Manager Hierarchy](#7-manager-hierarchy)
8. [Backfill & Open Headcount](#8-backfill--open-headcount)

### Part 3: App-Specific Logic
9. [Data Import Flow](#9-data-import-flow)
10. [Assignment Engine](#10-assignment-engine)
11. [Optimization Model](#11-optimization-model)
12. [Balancing & Thresholds](#12-balancing--thresholds)
13. [Analytics & Success Metrics](#13-analytics--success-metrics)

### Appendix
- [Code Locations](#appendix-code-locations)
- [Maintenance Rules](#maintenance-rules)

---

# Part 1: Core Business Definitions

> ğŸ“‹ **What's here**: Terminology, revenue formulas, account types, geography, tiers, normalization.  
> These rules exist independently of the app - they're universal business definitions.

---

## 1. Glossary & Terminology

| Term | Full Name | Definition |
|------|-----------|------------|
| **ARR** | Annual Recurring Revenue | Actual contracted revenue from existing customers |
| **ATR** | Available To Renew | Revenue coming up for renewal (timing, NOT risk) |
| **CRE** | Customer Renewal at Risk | Accounts flagged as churn risk (separate from ATR) |
| **Pipeline** | Prospect Pipeline | Potential revenue from open opportunities (not yet closed) |
| **Parent Account** | Ultimate Parent | Top-level account in a corporate hierarchy |
| **Child Account** | Subsidiary | Account that belongs to a parent hierarchy |
| **Split Ownership** | | When a child account has a different owner than its parent |
| **Strategic Account** | | High-value accounts assigned to dedicated Strategic reps. No capacity limits apply. |
| **PE Firm** | Private Equity | Accounts owned by specific PE firms may have special handling rules |
| **Rep** | Sales Representative | Individual contributor who owns accounts |
| **Strategic Rep** | | Reps who only receive strategic accounts; strategic accounts must only be assigned to strategic reps |
| **FLM** | First Line Manager | Direct manager of Reps. Approves Rep book changes. |
| **SLM** | Second Line Manager | Manager of FLMs. Reviews FLM-approved changes. |
| **RevOps** | Revenue Operations | Final approver. Executes assignments to Salesforce. |
| **Backfill Source** | | Rep who is leaving. Accounts need reassignment. |
| **Backfill Target** | | New Rep created to receive accounts from leaving Rep. |
| **Placeholder** | Open Headcount | A slot for a future hire, used for capacity planning. |

### Important Distinctions

- **ARR vs Pipeline**: ARR is real revenue (customers). Pipeline is potential (prospects). Never mix.
- **ATR vs CRE**: ATR = timing (when does revenue renew). CRE = risk (might churn). Independent metrics. Note: ATR is a subset of ARRâ€”specifically, revenue from renewal opportunities.
- **Parent vs Child**: Business relationship, not data hierarchy. A parent can be a customer while child is prospect.
- **Parent-Child Assignment**: Implicit priority to keep parent and child accounts with the same rep to maintain relationship continuity.

---

## 2. Revenue Metrics

**Impl**: `calculations.ts` - `getAccountARR()`, `getAccountATR()`, `calculatePipelineFromOpportunities()`

### 2.1 ARR Calculation

**Rule**: Same priority chain for ALL accounts to prevent double-counting.

**Priority Order**:
1. `hierarchy_bookings_arr_converted` - FIRST (prevents double-counting from children)
2. `calculated_arr` - Fallback with adjustments
3. `arr` - Raw import value, last resort
4. `0` - Default if no data

```typescript
// Same logic for ALL accounts
function getAccountARR(account) {
  return account.hierarchy_bookings_arr_converted || account.calculated_arr || account.arr || 0;
}
```

**Why hierarchy_bookings first?**
- Children share the parent's `hierarchy_bookings_arr_converted` value
- Using `calculated_arr` first could cause double-counting when summing across a hierarchy
- This ensures consistent totals regardless of how accounts are grouped

### 2.2 ATR Calculation

**Impl**: `calculations.ts` - `getAccountATR()`, `isRenewalOpportunity()`, `calculateATRFromOpportunities()`

**Rule**: ATR = SUM of `available_to_renew` from **Renewal opportunities only**

```typescript
ATR = SUM(opportunities.available_to_renew) 
      WHERE opportunity_type = 'Renewals'
```

**Critical**: 
- Only include opportunities where `opportunity_type` (case-insensitive) equals "Renewals"
- Other opportunity types (New Business, Expansion, etc.) do NOT count toward ATR
- ATR is about timing, not risk

### 2.3 Pipeline Calculation

**Rule**: Pipeline = SUM of `net_arr` from prospect opportunities AND expansion opportunities on customer accounts

```typescript
Pipeline = SUM(opportunities.net_arr)
           WHERE account.is_customer = false
           OR opportunity_type = 'Expansion'
```

**Why include Expansion?** Customer accounts with expansion opportunities represent real pipeline value that should be balanced across reps.

**Fallback**: If `net_arr` is null, use `amount` field.

---

## 3. Account Classification

**Impl**: `calculations.ts` - `isCustomer()`, `hasARR()`

### 3.1 Customer vs Prospect

| Type | Definition | Identifying Logic |
|------|------------|-------------------|
| **Customer** | Account with existing revenue | `getAccountARR(account) > 0` |
| **Prospect** | Account without existing revenue | `getAccountARR(account) === 0` |

```typescript
// From _domain/calculations.ts
function isCustomer(account) {
  // First check explicit is_customer field if set
  if (account.is_customer !== undefined) {
    return account.is_customer;
  }
  // Otherwise derive from ARR
  return getAccountARR(account) > 0;
}
```

**Note**: The `isCustomer()` function uses the same ARR priority chain as `getAccountARR()`. This ensures consistent classification.

**Exception**: Some filtering code (e.g., in `buildDataService.ts`) intentionally checks ONLY `hierarchy_bookings_arr_converted > 0` for customer classification. This is safer and prevents false positives from `calculated_arr` on child accounts. See `_domain/CLEANUP_PLAN.md` for details.

### 3.2 Parent vs Child

| Type | Definition | Identifying Logic |
|------|------------|-------------------|
| **Parent** | Top of hierarchy | `ultimate_parent_id` is null/empty |
| **Child** | Belongs to parent | `ultimate_parent_id` has a value |

```typescript
function isParentAccount(account) {
  return !account.ultimate_parent_id || account.ultimate_parent_id.trim() === '';
}
```

### 3.3 Split Ownership

When a child account has a **different owner** than its parent:
- The child's ARR is counted separately for the child's owner
- The parent's `hierarchy_bookings_arr_converted` does NOT include this child's ARR
- Both owners have the account in their book for different metrics

---

## 4. Geography & Territories

**Impl**: `geography.ts` - `REGION_HIERARCHY`, `REGION_ANCESTRY`, `calculateGeoMatchScore()`, `autoMapTerritoryToUSRegion()`

> **AI Integration Note**: Geography data is provided to the AI model to help identify territory-to-region relationships and suggest optimal mappings.

### 4.1 Region Hierarchy

**AMER** (Americas - includes Canada)
```
AMER
â”œâ”€â”€ North East (NY, MA, PA, NJ, CT, etc. + Quebec, Ontario)
â”œâ”€â”€ South East (TX, FL, GA, NC, VA, DC, etc.)
â”œâ”€â”€ Central (IL, OH, CO, MN, MI, etc. + Alberta)
â””â”€â”€ West (CA, WA, OR, AZ, etc. + British Columbia)

EMEA (Europe, Middle East, Africa)
â”œâ”€â”€ UK (United Kingdom, Ireland)
â”œâ”€â”€ DACH (Germany, Austria, Switzerland)
â”œâ”€â”€ France
â”œâ”€â”€ Nordics (Sweden, Norway, Denmark, Finland)
â”œâ”€â”€ Southern Europe (Spain, Italy, Portugal)
â”œâ”€â”€ Benelux (Netherlands, Belgium, Luxembourg)
â”œâ”€â”€ Middle East
â””â”€â”€ Africa

APAC (Asia Pacific)
â”œâ”€â”€ ANZ (Australia, New Zealand)
â”œâ”€â”€ Japan
â”œâ”€â”€ Southeast Asia (Singapore, Malaysia, Thailand, Vietnam, Philippines, Indonesia)
â”œâ”€â”€ India
â”œâ”€â”€ Greater China (China, Hong Kong, Taiwan)
â””â”€â”€ Korea
```

### 4.2 Territory-to-Region Mapping

Accounts have a `sales_territory` field with free-text values. We map these to regions:

| Territory Value | Maps To | Rule |
|-----------------|---------|------|
| "California", "CA", "San Francisco" | West | State/city name |
| "NYC", "New York", "Boston" | North East | City name |
| "Texas", "Dallas", "Houston" | South East | State/city name |
| "Chicago", "IL", "Midwest" | Central | State/city/keyword |
| "UK", "London", "Britain" | UK | Country/city name |
| "Global", "Worldwide" | UNMAPPED | Requires manual mapping |

**Priority Order for Matching**:
1. Keywords (most specific) - e.g., "PAC NW" â†’ West
2. Cities - e.g., "San Francisco" â†’ West
3. State codes - e.g., "CA" â†’ West

**EMEA Country Mapping**:

**Impl**: `commercialPriorityHandlers.ts` - `EMEA_COUNTRY_TO_SUBREGION`

| Sub-Region | Countries |
|------------|-----------|
| DACH | DE, AT, CH (Germany, Austria, Switzerland) |
| UKI | GB, UK, IE (United Kingdom, Ireland) |
| Nordics | SE, NO, DK, FI, IS |
| France | FR |
| Benelux | NL, BE, LU |
| Southern Europe | ES, IT, PT |
| Middle East | AE, SA, IL, QA, KW, BH, OM |

### 4.3 Geo Match Scoring (Hierarchy-Based)

**Impl**: `constants.ts` - `GEO_MATCH_SCORES`

Geography matching rewards **specificity**. More specific matches score higher:

```
HIERARCHY (most specific at bottom):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Global (can take anything)
â”œâ”€â”€ AMER / EMEA / APAC (Parent Region)
â”‚   â”œâ”€â”€ North East / UK / ANZ (Sub-Region)
â”‚   â”‚   â””â”€â”€ NYC / Boston / etc. (Territory - most specific)
```

| Match Type | Score | Example |
|------------|-------|---------|
| **Exact Match** | 1.00 | Account "North East" â†’ Rep "North East" |
| **Same Sub-Region** | 0.85 | Account "NYC" â†’ Rep "North East" (NYC maps to NE) |
| **Same Parent** | 0.65 | Account "North East" â†’ Rep "AMER" |
| **Global Fallback** | 0.40 | Account "NYC" â†’ Rep "Global" |
| **Cross-Region** | 0.20 | Account "West" â†’ Rep "EMEA" (avoid!) |
| **Unknown** | 0.50 | Can't determine territory |

**Key Principle**: The optimization model should reward specificity. 
- NYC account â†’ NYC rep is ideal (1.0)
- NYC account â†’ North East rep is good (0.85) 
- NYC account â†’ AMER rep is acceptable (0.65)
- NYC account â†’ Global rep is last resort (0.40)
- France account â†’ France rep (exact) â†’ EMEA rep (parent fallback)

---

## 5. Team Tiers

**Impl**: `tiers.ts` - `classifyTeamTier()`, `TEAM_TIER_ORDER`, `getTierDistance()`, `isEnterprise()`, `parseExpansionTier()`, `getAccountExpansionTier()`
**Constants**: `constants.ts` - `TIER_THRESHOLDS`, `HIGH_VALUE_ARR_THRESHOLD`

### 5.1 Team Tier (Employee-Based)

| Tier | Employee Count | Rep Specialization |
|------|----------------|-------------------|
| **SMB** | < 100 employees | Small Business |
| **Growth** | 100-499 employees | Scaling companies |
| **MM** | 500-1,499 employees | Mid-Market |
| **ENT** | 1,500+ employees | Enterprise |
| **(null)** | Unknown/unmapped | No tier assigned |

```typescript
const TIER_THRESHOLDS = {
  SMB_MAX: 99,
  GROWTH_MAX: 499,
  MM_MAX: 1499
};

function classifyTeamTier(employees) {
  // Unknown employees â†’ null (don't force a tier on unmapped fields)
  if (employees == null) return null;
  if (employees <= 99) return 'SMB';
  if (employees <= 499) return 'Growth';
  if (employees <= 1499) return 'MM';
  return 'ENT';
}
```

**Null Handling**: If employee count is unknown, return `null` rather than forcing a tier. Let the consumer decide how to handle unmapped fields.

**âš ï¸ Data Quality Note**: 
- Team tier classification is **only relevant if employee count data is present and accurate**
- If `employees` field is null, 0, or missing â†’ tier is null â†’ team alignment scoring is skipped
- ENT threshold (1500+) was chosen to align with typical enterprise sales org structure
- These thresholds can be adjusted in `TIER_THRESHOLDS` constant if your org uses different breakpoints

### 5.2 Expansion Tier (Scoring-Based)

| Tier | Meaning | Used For |
|------|---------|----------|
| **Tier 1** | Highest priority | High expansion potential |
| **Tier 2** | Medium priority | Standard accounts |
| **Tier 3** | Lower priority | Smaller opportunity |
| **Tier 4** | Lowest priority | Minimal potential |

Source fields: `expansion_tier` (customers) or `initial_sale_tier` (prospects)

---

## 6. Data Normalization

**Impl**: `normalization.ts` - `normalizeRegion()`, `normalizePEFirm()`, `normalizeTeamTier()`

Imported data contains typos and variations. These are normalized on import.

### 6.1 Region Aliases

| Raw Import | Normalized To |
|------------|---------------|
| "NYC", "New York", "NY" | North East |
| "California", "CA", "SF" | West |
| "Texas", "TX", "Dallas" | South East |
| "Chicago", "IL", "Midwest" | Central |
| "Global", "Worldwide" | UNMAPPED |

### 6.2 PE Firm Aliases

| Raw Import | Normalized To |
|------------|---------------|
| "JMI", "JMI Equity" | JMI Private Equity |
| "Vista", "Vista Equity" | Vista Equity Partners |
| "TPG", "TPG Capital" | TPG Capital |

### 6.3 Team Tier Aliases

| Raw Import | Normalized To |
|------------|---------------|
| "small", "small business" | SMB |
| "grwth" (typo) | Growth |
| "mid market", "mid-market" | MM |
| "enterprise", "large" | ENT |

---

# Part 2: Organizational Structure

> ğŸ‘¥ **What's here**: Manager roles (Rep/FLM/SLM/RevOps), approval chains, backfill workflows.  
> How the sales org is structured and how changes flow through approvals.

---

## 7. Manager Hierarchy

**Impl**: `utils/approvalChainUtils.ts` - `getApprovalStepsForRegion()`, `getApprovalChainDescription()`

### 7.1 Role Definitions

| Role | Full Name | Description |
|------|-----------|-------------|
| **Rep** | Sales Representative | Individual contributor who owns accounts |
| **FLM** | First Line Manager | Direct manager of Reps. Reviews and approves Rep book changes. |
| **SLM** | Second Line Manager | Manager of FLMs. Reviews FLM-approved changes before RevOps. |
| **RevOps** | Revenue Operations | Final approver. Executes assignments to Salesforce. |

### 7.2 Hierarchy Structure

```
RevOps (Final Authority)
â””â”€â”€ SLM (Second Line Manager)
    â””â”€â”€ FLM (First Line Manager)
        â””â”€â”€ Rep (Account Owner)
```

**Data Fields**:
- `sales_reps.flm` â†’ First Line Manager name
- `sales_reps.slm` â†’ Second Line Manager name
- `sales_reps.manager` â†’ Legacy field (prefer FLM/SLM)

### 7.3 Approval Chain

When a Rep's book is modified, changes flow through an approval chain:

**Standard Flow (AMER, Global)**:
```
Rep Book â†’ FLM Approval â†’ SLM Approval â†’ RevOps Approval â†’ Approved
```

**EMEA Flow** (no SLMs in EMEA structure):
```
Rep Book â†’ FLM Approval â†’ RevOps Approval â†’ Approved
```

**Status Values**:
| Status | Meaning |
|--------|---------|
| `pending_flm` | Awaiting FLM approval |
| `pending_slm` | Awaiting SLM approval |
| `pending_revops` | Awaiting RevOps final approval |
| `approved` | Fully approved, ready to execute |
| `rejected` | Rejected at any level |

### 7.4 Portfolio Views

Dashboards group accounts by manager hierarchy:
- **FLM View**: All accounts owned by Reps under a specific FLM
- **SLM View**: All accounts owned by Reps under all FLMs reporting to an SLM
- Metrics (ARR, ATR, account count, tier distribution) roll up through hierarchy

---

## 8. Backfill & Open Headcount

### 8.1 Terminology

| Term | Definition |
|------|------------|
| **Backfill Source** | A Rep who is leaving. ALL accounts/prospects are removed from this rep and need reassignment. |
| **Backfill Target** | A Rep designated to receive accounts from the leaving Rep. Can be a new Rep or an existing Rep. |
| **Placeholder** | An open headcount slot (no actual person yet). Used for planning. |
| **Open Headcount** | Same as Placeholder - a slot for a future hire. |

> **Backfill Priority**: When the backfill target is a different (existing) rep rather than a new hire, they receive lower continuity priority than same-rep continuity. This is because the relationship is still changing, even if to a known target.

### 8.2 Data Fields

**Sales Reps Flags**:

| Field | Table | Purpose |
|-------|-------|---------|
| `is_active` | `sales_reps` | TRUE = Rep can receive new assignments |
| `include_in_assignments` | `sales_reps` | TRUE = Rep participates in assignment engine |
| `is_strategic_rep` | `sales_reps` | TRUE = Handles strategic accounts only |
| `is_manager` | `sales_reps` | TRUE = FLM/SLM role, may not carry accounts |
| `is_renewal_specialist` | `sales_reps` | TRUE = Focuses on renewals, different capacity |
| `is_backfill_source` | `sales_reps` | TRUE = Rep is leaving, excluded from assignments |
| `is_backfill_target` | `sales_reps` | TRUE = Rep was created as backfill for leaving Rep |
| `backfill_target_rep_id` | `sales_reps` | Links leaving Rep to their backfill Rep |
| `is_placeholder` | `sales_reps` | TRUE = Open headcount (no actual person) |

**Account Flags**:

| Field | Table | Purpose |
|-------|-------|---------|
| `is_customer` | `accounts` | TRUE = Has revenue (ARR > 0) |
| `is_parent` | `accounts` | TRUE = Top of hierarchy (no ultimate_parent_id) |
| `is_strategic` | `accounts` | TRUE = Strategic account, goes to strategic reps only |
| `exclude_from_reassignment` | `accounts` | TRUE = Manual lock, stays with current owner |
| `has_customer_hierarchy` | `accounts` | TRUE = Has child accounts |
| `has_split_ownership` | `accounts` | TRUE = Children have different owners than parent |

### 8.3 Backfill Workflow

1. **Mark Rep as Leaving**: Set `is_backfill_source = true`
   - Automatically sets `include_in_assignments = false`
   - Rep's accounts become available for reassignment

2. **Create Backfill Rep**: System auto-generates a backfill target
   - New Rep with `is_backfill_target = true`
   - Linked via `backfill_target_rep_id`

3. **Assignment Engine Behavior**:
   - Backfill source Reps get continuity score = 0 (relationship ending)
   - Accounts from leaving Reps can be migrated to their backfill target
   - Stability lock: `backfill_migration` routes accounts to target Rep

### 8.4 Placeholder/Open Headcount

When importing Reps CSV:
- If `rep_id` is blank but `name` is provided â†’ auto-generates placeholder ID
- Sets `is_placeholder = true`
- Used for capacity planning ("what if we hire 2 more reps?")

---

# Part 3: App-Specific Logic

> âš™ï¸ **What's here**: Data import, assignment engine, LP optimization model, balancing thresholds.  
> How the Book Builder application implements the business rules above.

---

## 9. Data Import Flow

### 9.1 Import Pipeline

```
CSV File â†’ Parse â†’ Validate â†’ Normalize â†’ Insert to Supabase
```

### 9.2 Import Tables

| Data Type | Table | Key Fields |
|-----------|-------|------------|
| Accounts | `accounts` | `sfdc_account_id`, `build_id` |
| Sales Reps | `sales_reps` | `rep_id`, `build_id` |
| Opportunities | `opportunities` | `sfdc_opportunity_id`, `build_id` |

### 9.3 Batch Sizes

**Impl**: `constants.ts` - `BATCH_SIZES`, `SUPABASE_LIMITS`

Database operations use batching to avoid timeouts:

| Operation | Batch Size | Reason |
|-----------|------------|--------|
| Import | 500 | Supabase request size limits |
| Update | 100 | Smaller batches for safety |
| Delete | 1000 | Faster cleanup |

**Supabase Limits**:
- Default page size: 1000 rows (use `.range()` for more)
- Max rows per insert: 500

```typescript
// From constants.ts
const BATCH_SIZES = { IMPORT: 500, UPDATE: 100, DELETE: 1000 };
const SUPABASE_LIMITS = { DEFAULT_PAGE_SIZE: 1000, MAX_ROWS_PER_INSERT: 500 };
```

### 9.4 Post-Import Calculations

After import, database functions compute:
- `calculated_arr`: ARR with opportunity adjustments
- `calculated_atr`: ATR rolled up from opportunities
- `is_parent`: Based on `ultimate_parent_id`
- `child_count`: Number of child accounts

### 9.5 Auto-Mapping System

**Impl**: `autoMapFields()` in autoMappingUtils.ts

The import system automatically maps CSV headers to database fields using a multi-tier matching strategy:

| Match Type | Priority | Confidence | Example |
|------------|----------|------------|---------|
| **Exact** | 1st | 1.0 | "Account Name" â†’ `account_name` |
| **Alias** | 2nd | 0.9 | "Company Name" â†’ `account_name` |
| **Pattern** | 3rd | 0.8 | "Acct_Nm" â†’ `account_name` (regex match) |
| **Fuzzy** | 4th | 0.6+ | "Accnt Name" â†’ `account_name` (string similarity) |

#### Field Alias Tables

**Accounts** (key mappings):

| Schema Field | Common Aliases |
|--------------|----------------|
| `sfdc_account_id` | Account ID (18), Account_ID, AccountID, SFDC_Account_ID |
| `account_name` | Account Name, Company Name, organization |
| `owner_id` | Account Owner User ID, Owner_ID, Sales_Rep_ID |
| `owner_name` | Account Owner: Full Name, Sales_Rep, account_manager |
| `hierarchy_bookings_arr_converted` | Hierarchy Bookings ARR, Hierarchy ARR |
| `employees` | ROE Employee Count, Employee_Count, headcount |
| `sales_territory` | ROE Sales Territory, Territory, Territory_Code |
| `pe_firm` | Related Partner Account: Related Partner Account Name, PE Firm, Private_Equity_Firm |
| `ultimate_parent_id` | Financial Ultimate Parent: Account ID (18), Parent_ID |

**Sales Reps** (key mappings):

| Schema Field | Common Aliases |
|--------------|----------------|
| `rep_id` | Rep_ID, Sales_Rep_ID, Employee_ID, SFDC_ID |
| `name` | Rep Name, Full_Name, Sales_Rep_Name |
| `email` | Email, Rep_Email, Work_Email |
| `region` | Region, Sales_Region, Territory |
| `team` | Team, Sales_Team, Team_Name (SMB/Growth/MM/ENT) |
| `slm_name` | SLM, SLM_Name, Second_Line_Manager |
| `flm_name` | FLM, FLM_Name, First_Line_Manager |
| `is_backfill_source` | Backfill_Source, Is_Leaving |
| `backfill_target_rep_id` | Backfill_Target, Target_Rep_ID |

**Opportunities** (key mappings):

| Schema Field | Common Aliases |
|--------------|----------------|
| `sfdc_opportunity_id` | Opportunity_ID, Opp_ID |
| `sfdc_account_id` | Account_ID, Related_Account_ID |
| `opportunity_type` | Opportunity Type, Opp_Type |
| `available_to_renew` | Available to Renew (converted), ATR |
| `net_arr` | Net ARR (converted), Net_ARR, NARR |
| `cre_status` | CRE_Status, Customer_Risk, renewal_risk |

> **Full alias lists**: See `ACCOUNT_FIELD_ALIASES`, `SALES_REP_FIELD_ALIASES`, `OPPORTUNITY_FIELD_ALIASES` in `utils/autoMappingUtils.ts`

---

## 10. Assignment Engine

**Impl**: `simplifiedAssignmentEngine.ts`, `config/priorityRegistry.ts`

> **TL;DR**: Assignments run through priority levels P0â†’P7. P0-P2 are "holdover" (locked). P3-P7 are "optimization" (LP solver decides). Priorities are customizable per mode (COMMERCIAL, ENT, EMEA, APAC).

### 10.1 Priority Waterfall (Customizable)

> âš ï¸ **Priorities are customizable.** The order below is the default. Users can reorder, enable/disable priorities via the UI. Config is stored in `assignment_configuration.priority_config`.

> **Mode-Based Defaults**: Priority order defaults based on detected book type (ENT, COMMERCIAL, EMEA, APAC). See Â§10.3 for mode-specific configurations.

Assignments are processed in priority order. Each level runs before the next:

| Priority | ID | Name | Type | Description |
|----------|-----|------|------|-------------|
| **P0** | `manual_holdover` | Manual Holdover | Holdover | Locked accounts stay put, strategic â†’ strategic reps |
| **P1** | `sales_tools_bucket` | Sales Tools Bucket | Holdover | Low-ARR customers (<$25K) â†’ Sales Tools |
| **P2** | `stability_accounts` | Stability Accounts | Holdover | CRE risk, renewal soon, PE firm, recent change |
| **P3** | `team_alignment` | Team Alignment | Optimization | Match account tier to rep tier |
| **P4** | `geo_and_continuity` | Geo + Continuity | Optimization | Current owner if geography matches |
| **P5** | `continuity` | Continuity | Optimization | Prefer current owner |
| **P6** | `geography` | Geography | Optimization | Match territory to region |
| **P7** | `arr_balance` | Residual | Optimization | Balance remaining accounts |

### 10.2 Priority Types

- **Holdover**: Account is LOCKED to current owner. Runs before optimization.
- **Optimization**: Account is available for reassignment. LP solver decides.

### 10.3 Preset Configurations by Mode

**Impl**: `modeDetectionService.ts`

Different sales motions use different priority orders:

| Mode | Description | Key Differences |
|------|-------------|-----------------|
| **COMMERCIAL** | Standard B2B sales | Includes Sales Tools bucket, team alignment |
| **ENT** | Enterprise accounts | No Sales Tools, strategic-focused |
| **EMEA** | European motion | Sub-region routing (DACH, UKI, Nordics, etc.) |
| **APAC** | Asia-Pacific | Similar to EMEA |

**Auto-Detection Logic**:
The system auto-detects mode based on build data:

| Signal | Detected Mode | Confidence |
|--------|---------------|------------|
| Build region = APAC | APAC | High |
| Build region = EMEA | EMEA | High |
| Has team alignment data (employees + rep tiers) | COMMERCIAL | High |
| Has Renewal Specialists OR PE accounts | COMMERCIAL | Medium |
| Default (AMER/GLOBAL, no RS/PE data) | ENT | High |

### 10.4 Sales Tools Routing (Commercial Mode)

> **DEPRECATED**: Renewal Specialist concept has been removed. Commercial accounts <$25k now route to Sales Tools bucket.

**Impl**: `commercialPriorityHandlers.ts`

In Commercial mode, low-ARR customer accounts are routed to the Sales Tools bucket:

| Condition | Routing | Rationale |
|-----------|---------|-----------|
| ARR < $25,000 | Route to Sales Tools | Free up AE capacity for higher-value accounts |
| ARR â‰¥ $25,000 | Keep with AE | Accounts above threshold get dedicated rep attention |

**Default Priority Order by Mode**:

```
COMMERCIAL:  P0 â†’ P1 â†’ P2 â†’ P3 â†’ P4 â†’ P5 â†’ P6 â†’ P7
             (holdover) (sales) (stab) (team) (geo+cont) (cont) (geo) (residual)

ENT:         P0 â†’ P1 â†’ P2 â†’ P3 â†’ P4 â†’ P5
             (holdover) (stab) (geo+cont) (cont) (geo) (residual)
             [No sales_tools_bucket, no team_alignment]

EMEA/APAC:   P0 â†’ P1 â†’ P2 â†’ P3 â†’ P4 â†’ P5 â†’ P6
             (holdover) (stab) (geo+cont) (cont) (geo) (team) (residual)
             [Team alignment after geography]
```

### 10.5 Priority Conditions (Detailed)

#### P0: Manual Holdover (Locked)
**Condition**: `exclude_from_reassignment = true` OR `is_strategic = true`
**Effect**: Account stays with current owner. Cannot be disabled.

#### P1: Sales Tools Bucket (COMMERCIAL only)
**Condition**: `hierarchy_bookings_arr_converted < $25,000` AND `is_customer = true`
**Effect**: Routes to Sales Tools team (no SLM/FLM hierarchy)

#### P2: Stability Accounts (Sub-conditions)
Each sub-condition can be enabled/disabled independently:

| Sub-condition | ID | Condition | Default |
|---------------|-----|-----------|---------|
| CRE Risk | `cre_risk` | `cre_risk = true` | Enabled |
| Renewal Soon | `renewal_soon` | `renewal_date` within 90 days | Enabled |
| PE Firm | `pe_firm` | `pe_firm IS NOT NULL` | Enabled |
| Recent Change | `recent_owner_change` | `owner_change_date` within 90 days | Enabled |

#### P3: Team Alignment
**Condition**: Account tier matches rep tier
**Penalty System**:
- Exact match (ENTâ†’ENT): No penalty
- 1-level mismatch (ENTâ†’MM): Î³ penalty (100)
- 2+ level mismatch (ENTâ†’SMB): Îµ penalty (1000)

#### P4-P6: Optimization Priorities
These become **weights in the LP objective function**, not hard constraints:
- **Geo + Continuity**: Score = geo_score Ã— continuity_score
- **Continuity**: Score = tenure + stability + value weight
- **Geography**: Score = region match level

#### P7: Residual Optimization (Locked)
**Condition**: All remaining unassigned accounts
**Effect**: Multi-metric balancing (ARR, ATR, tier). Cannot be disabled.

### 10.6 Strategic Accounts (P0)

Strategic accounts are handled separately from normal accounts:

| Rule | Description |
|------|-------------|
| **Separate Pool** | Strategic accounts only go to strategic reps (`is_strategic_rep = true`) |
| **No Capacity Limits** | Strategic reps are not subject to ARR/account capacity constraints |
| **Balanced Distribution** | Accounts distributed evenly by ARR across strategic reps |
| **Continuity First** | If current owner is strategic rep, account stays |

**Data Fields**:
- `accounts.is_strategic` â†’ TRUE = strategic account
- `sales_reps.is_strategic_rep` â†’ TRUE = strategic rep

### 10.7 PE Firm Accounts (P2)

| Rule | Description |
|------|-------------|
| **Stability Lock** | PE accounts stay with current owner (relationship continuity) |
| **PE Firm Normalization** | Typos normalized on import (see Section 6.2) |

**Data Fields**:
- `accounts.pe_firm` â†’ PE firm name (normalized)

### 10.8 Key Constants

| Constant | Value | Source | Purpose |
|----------|-------|--------|---------|
| `DEFAULT_CONTINUITY_DAYS` | 90 | constants.ts | Days for stability protection |
| `SALES_TOOLS_ARR_THRESHOLD` | $25,000 | constants.ts | Customer accounts under this â†’ Sales Tools bucket |
| `HIGH_VALUE_ARR_THRESHOLD` | $100,000 | constants.ts | Legacy default - for high-value metrics only (does NOT override tier) |
| `DEFAULT_MAX_ARR_PER_REP` | $2,500,000 | constants.ts | Default maximum ARR a single rep should manage |
| `DEFAULT_OVERLOAD_VARIANCE` | 20% | constants.ts | Variance from target before rep is overloaded (configurable) |
| `STRATEGIC_VARIANCE` | 20% | optimizationSolver.ts | Variance band for strategic account balancing |
| `HIGH_VALUE_THRESHOLD` | $500,000 | metricsCalculator.ts | Legacy default - threshold for continuity metrics |

> **Important**: Team tier is determined by employee count only (see Â§5.1). High ARR does NOT override the employee-based tier classification.

---

## 11. Optimization Model

> **TL;DR**: Uses HiGHS LP solver. Maximizes `score = continuity + geography + team_alignment` while penalizing imbalance. Three-tier penalty system (Î±=0.01, Î²=1.0, BigM=1000) keeps reps balanced. Locked accounts are hard constraints; everything else is optimized.

### 11.1 Model Formulations: Waterfall vs Relaxed

The app supports two assignment models:

| Model | Description | When to Use |
|-------|-------------|-------------|
| **Waterfall** | Cascading priority levels (P0â†’P7). Each level locks accounts before next level runs. | When priority order is strict (strategic â†’ stability â†’ optimization) |
| **Relaxed** | Single global LP solve with weighted objectives. All factors considered simultaneously. | When seeking globally optimal balance |

**Waterfall Formulation**:
```
For each priority P0 through P7:
  1. Identify accounts matching priority criteria
  2. Assign accounts (lock them to selected rep)
  3. Remove assigned accounts from pool
  4. Continue to next priority
```

**Relaxed Formulation**:
```
Maximize: Î£ (score_ij Ã— x_ij) - Penalties

Where:
- x_ij = binary decision variable (account i â†’ rep j)
- score_ij = continuity + geography + team_alignment
- Penalties = balance deviation penalties
```

**Why Both Matter**:
- **Waterfall**: Guarantees priority order is respected (strategic accounts ALWAYS go first)
- **Relaxed**: May find better global balance but could assign lower-priority factors first

### 11.2 Solver & Full LP Formulation

**Impl**: `lpProblemBuilder.ts`, `highsWrapper.ts`

The app uses **HiGHS** (open-source LP solver) for account assignment.

#### Complete LP Problem

```
MAXIMIZE:
  Î£áµ¢â±¼ (score_ij Ã— x_ij)                     // Assignment scores
  - Î£â±¼ (Î±_penalty Ã— Î±_over_j + Î±_penalty Ã— Î±_under_j)    // Alpha penalties
  - Î£â±¼ (Î²_penalty Ã— Î²_over_j + Î²_penalty Ã— Î²_under_j)    // Beta penalties
  - Î£â±¼ (BigM_penalty Ã— M_over_j + BigM_penalty Ã— M_under_j)  // BigM penalties

SUBJECT TO:

  // 1. ASSIGNMENT CONSTRAINT: Each account assigned to exactly one rep
  âˆ€i: Î£â±¼ x_ij = 1

  // 2. CAPACITY CONSTRAINT: Rep cannot exceed hard ARR cap
  âˆ€j: Î£áµ¢ (ARR_i Ã— x_ij) â‰¤ hardCapARR_j

  // 3. STABILITY LOCK: Locked accounts must stay with current owner
  âˆ€(i,j) where locked: x_ij = 1 (for current owner j)
  âˆ€(i,k) where locked: x_ik = 0 (for all other reps k â‰  j)

  // 4. BALANCE CONSTRAINT (with 3-tier slack):
  âˆ€j: Î£áµ¢ (metric_i Ã— x_ij) = target_j + Î±_over - Î±_under + Î²_over - Î²_under + M_over - M_under

  // 5. PARENT-CHILD CONSTRAINT: Same owner for parent and children
  // This is an implicit priority - the optimizer tries to keep parent/child together
  âˆ€(parent p, child c): x_pj = x_cj for all j

VARIABLE TYPES:
  x_ij âˆˆ {0, 1}                    // Binary: assign account i to rep j
  Î±_over, Î±_under â‰¥ 0              // Continuous: variance slack
  Î²_over, Î²_under â‰¥ 0              // Continuous: buffer slack  
  M_over, M_under â‰¥ 0              // Continuous: violation slack

BOUNDS:
  Î±_over â‰¤ prefMax - target        // Can't exceed variance band
  Î±_under â‰¤ target - prefMin
  Î²_over â‰¤ max - prefMax           // Can't exceed buffer zone
  Î²_under â‰¤ prefMin - min
  M_over, M_under: unbounded       // But 1000x penalty makes it prohibitive
```

#### Score Composition

```
score_ij = w_cont Ã— continuity_score(i,j) 
         + w_geo Ã— geography_score(i,j)
         + w_team Ã— team_alignment_score(i,j)

Where weights are normalized to sum to 1.0
```

#### Default Objective Weights

**Impl**: `optimization/types.ts` - `DEFAULT_LP_OBJECTIVES_CUSTOMER`, `DEFAULT_LP_OBJECTIVES_PROSPECT`

| Factor | Customer Weight | Prospect Weight |
|--------|-----------------|-----------------|
| Continuity | 0.35 | 0.20 |
| Geography | 0.35 | 0.45 |
| Team Alignment | 0.30 | 0.35 |

**Why different?**
- **Customers**: Continuity matters more (existing relationship)
- **Prospects**: Geography matters more (rep needs to be local for new business)

#### Default Balance Configuration

**Impl**: `optimization/types.ts` - `DEFAULT_LP_BALANCE_CONFIG`

| Metric | Variance Band | Penalty | Hard Cap |
|--------|---------------|---------|----------|
| ARR | Â±10% | 0.5 | $3,000,000 |
| ATR | Â±15% | 0.3 | $750,000 |
| Pipeline | Â±15% | 0.4 | $1,000,000 |

### 11.3 Three-Tier Penalty System (Alpha, Beta, BigM)

Balance constraints use a **three-tier penalty system** to handle deviation from targets:

```
actual_value = target + Î±_over - Î±_under + Î²_over - Î²_under + BigM_over - BigM_under
```

| Zone | Variable | Penalty Weight | Description |
|------|----------|---------------|-------------|
| **Alpha (Î±)** | Within variance band | 0.01 | Small penalty - expected/acceptable deviation |
| **Beta (Î²)** | Buffer zone | 1.0 | Medium penalty - undesirable but not catastrophic |
| **BigM** | Beyond absolute limits | 1000.0 | Huge penalty - effectively forbidden |

**Why Three Tiers?**
- **Alpha**: Allows the solver flexibility within the configured variance band (soft constraint). Penalty scales linearly the further you deviate from target.
- **Beta**: Warns when approaching hard limits, but still feasible. Also uses linear penalty scaling.
- **BigM**: Makes violations extremely expensive â†’ treated as hard constraints

**Visual Representation**:
```
         â†â”€â”€â”€â”€â”€ Î²_under â”€â”€â”€â”€â”€â†’â†â”€â”€ Î±_under â”€â”€â†’ TARGET â†â”€â”€ Î±_over â”€â”€â†’â†â”€â”€â”€â”€â”€ Î²_over â”€â”€â”€â”€â”€â†’
         |                    |               |               |                    |
       min                 prefMin         target         prefMax                max
    (absolute)           (variance)                      (variance)          (absolute)
```

**Bounds**:
```typescript
Î±_over_bound  = max(0, prefMax - target)      // Variance band above target
Î±_under_bound = max(0, target - prefMin)      // Variance band below target
Î²_over_bound  = max(0, max - prefMax)         // Gap to absolute max
Î²_under_bound = max(0, prefMin - min)         // Gap to absolute min
BigM: unbounded (but 1000x penalty makes it prohibitive)
```

### 11.4 Scoring Functions

#### Continuity Score (Account-Rep Pair)

```
Score = base + tenure_weightÃ—T + stability_weightÃ—B + value_weightÃ—V
```

| Component | Formula | Description |
|-----------|---------|-------------|
| **T** (Tenure) | `min(days_with_owner / 730, 1.0)` | 2-year cap on tenure value |
| **B** (Stability) | `1 - (owner_count - 1) / (max_owners - 1)` | Fewer owners = higher score |
| **V** (Value) | `min(ARR / $2M, 1.0)` | Higher ARR = more valuable continuity |

> **Data Quality Note**: The `days_with_owner` field is often empty in imported data. When empty, tenure scoring falls back to default behavior.

**Special Cases**:
- Not current owner â†’ 0
- Rep is backfill source (leaving) â†’ 0
- No current owner â†’ 0

**Default Params** (from `optimization/types.ts`):
```typescript
{
  base_continuity: 0.10,
  tenure_weight: 0.35,
  stability_weight: 0.30,
  value_weight: 0.25,
  tenure_max_days: 730,
  stability_max_owners: 5,
  value_threshold: 2_000_000
}
```

#### Geography Score (Account-Rep Pair)

**Impl**: `optimization/scoring/geographyScore.ts`

Uses region hierarchy for scoring:

| Match Type | LP Score | Example |
|------------|----------|---------|
| **Exact Match** | 1.00 | Account "North East" â†’ Rep "North East" |
| **Sibling Region** | 0.65 | Account "NYC" â†’ Rep "Boston" (both in NE) |
| **Same Parent** | 0.40 | Account "North East" â†’ Rep "AMER" |
| **Cross-Region** | 0.20 | Account "West" â†’ Rep "EMEA" |
| **Unknown** | 0.50 | Can't determine territory |

**Note**: `_domain/constants.ts` has slightly different values (`SAME_SUB_REGION: 0.85`, `SAME_PARENT: 0.65`) used for analytics display. The LP solver uses the values above.

**Advanced Geo Mapping**:
The model can boost specificity by mapping city/state to specific regions:
```
Territory "San Francisco" â†’ "West" (auto-map)
Territory "NYC" â†’ "North East" (auto-map)
Territory "Custom District" â†’ Explicit mapping in territory_mappings
```

**Why Specificity Matters**: 
More specific geo mappings â†’ higher exact match rates â†’ better geo scores â†’ better overall assignment quality.

#### Team Alignment Score

**Impl**: `optimization/scoring/teamAlignmentScore.ts`

Scores based on tier distance (discrete values, not linear):

| Distance | Score | Example |
|----------|-------|---------|
| 0 (exact) | 1.00 | ENT account â†’ ENT rep |
| 1 level | 0.60 | ENT account â†’ MM rep |
| 2 levels | 0.25 | ENT account â†’ Growth rep |
| 3 levels | 0.05 | ENT account â†’ SMB rep |
| Unknown | 0.50 | Missing employee count |

**Reaching Down Penalty**: When a higher-tier rep is assigned to a lower-tier account (e.g., ENT rep â†’ SMB account), an additional penalty is applied:
```
penalty = reaching_down_penalty Ã— tier_distance
final_score = max(0, base_score - penalty)
```
Default `reaching_down_penalty = 0.15`. This discourages putting expensive ENT reps on small accounts.

| Tier | Index | Employee Count |
|------|-------|----------------|
| SMB | 0 | < 100 (`TIER_THRESHOLDS.SMB_MAX = 99`) |
| Growth | 1 | 100 - 499 (`TIER_THRESHOLDS.GROWTH_MAX = 499`) |
| MM | 2 | 500 - 1,499 (`TIER_THRESHOLDS.MM_MAX = 1499`) |
| ENT | 3 | 1,500+ |
| (null) | -1 | Unknown - alignment not scored |

**Data Quality Note**: Team tier scoring is only meaningful if employee count data is accurate. If `employees` field is null or 0, tier is null and alignment scoring is skipped.

### 11.5 Account Locking Priorities

**Impl**: `optimization/types.ts` - `DEFAULT_LP_STABILITY_CONFIG`, `constraints/stabilityLocks.ts`

Accounts can be locked to their current owner (or backfill target). Locks are evaluated **in priority order** - first match wins:

| Priority | Lock Type | Condition | Effect |
|----------|-----------|-----------|--------|
| 1 | **Manual Lock** | `exclude_from_reassignment = true` | Stay with current owner |
| 2 | **Backfill Migration** | Owner `is_backfill_source = true` | Migrate to backfill target rep |
| 3 | **CRE Risk** | `cre_risk = true` | Stay with current owner (relationship stability) |
| 4 | **Renewal Soon** | `renewal_date` within 90 days | Stay with current owner |
| 5 | **PE Firm** | `pe_firm` is set | Stay with current owner |
| 6 | **Recent Change** | `owner_change_date` within 90 days | Stay with current owner |

**Stability Config Defaults**:
```typescript
// From optimization/types.ts
const DEFAULT_LP_STABILITY_CONFIG = {
  cre_risk_locked: true,
  renewal_soon_locked: true,
  renewal_soon_days: 90,
  pe_firm_locked: true,
  recent_change_locked: true,
  recent_change_days: 90,
  backfill_migration_enabled: true
};
```

**Important**: Locked accounts become **hard constraints** in the LP. They are not part of the optimization - they are pre-assigned.

### 11.6 LP Objective Weights

**Impl**: `optimization/types.ts` - `LPObjectivesConfig`

The LP solver weighs three scoring factors differently for customers vs prospects:

**Customer Objective Weights** (relationship-focused):
| Factor | Weight | Rationale |
|--------|--------|-----------|
| Continuity | 0.35 | Preserve existing relationships |
| Geography | 0.35 | Regional alignment matters |
| Team Alignment | 0.30 | Match account complexity to rep tier |

**Prospect Objective Weights** (coverage-focused):
| Factor | Weight | Rationale |
|--------|--------|-----------|
| Continuity | 0.20 | Less relationship history |
| Geography | 0.45 | Territory alignment is primary |
| Team Alignment | 0.35 | Fair distribution by potential |

```typescript
// From optimization/types.ts
const DEFAULT_LP_OBJECTIVES_CUSTOMER = {
  continuity_weight: 0.35,
  geography_weight: 0.35,
  team_alignment_weight: 0.30
};

const DEFAULT_LP_OBJECTIVES_PROSPECT = {
  continuity_weight: 0.20,
  geography_weight: 0.45,
  team_alignment_weight: 0.35
};
```

### 11.7 Balance Weights (for Dashboard/Analytics)

These weights are used for **balance calculations** in dashboards, separate from LP scoring:

```typescript
// From _domain/constants.ts
const DEFAULT_OPTIMIZATION_WEIGHTS = {
  CUSTOMER: { ARR: 0.50, ATR: 0.25, TIER: 0.25 },
  PROSPECT: { PIPELINE: 0.50, TIER: 0.50 },
};
```

**Note on Tier Balancing**: Each tier (Tier 1, 2, 3, 4) is balanced individually, not grouped. The TIER weight applies to each tier's distribution separately.

### 11.8 Balance Penalties

**Impl**: `optimization/types.ts` - `LPBalanceConfig`

The solver penalizes imbalance using the three-tier system:

| Metric | LP Variance | Alpha Penalty | Beta Penalty | BigM Penalty |
|--------|-------------|---------------|--------------|--------------|
| ARR | Â±10% | 0.01 | 1.0 | 1000.0 |
| ATR | Â±15% | 0.01 | 1.0 | 1000.0 |
| Pipeline | Â±15% | 0.01 | 1.0 | 1000.0 |
| Tier | Â±20% (Î² only) | - | 1.0 | - |

> **Configuration Note**: Variance bands and maximum values should come from the assignment configuration, not be hardcoded. The values above are defaults that can be overridden per-build.

**Note**: LP variance bands are tighter than dashboard defaults (which use Â±25%). This is intentional - the solver aims for tighter balance while dashboards show a wider acceptable range.

**Tier Balance**: Uses Î²-only penalties (soft approach) since tier counts are harder to balance exactly.

### 11.9 Rationale Generation

The optimization generates human-readable rationales for each assignment:

| Priority Level | Rationale Format |
|----------------|------------------|
| P0 Strategic | `P0: Strategic Account â†’ {rep_name} (strategic rep, ARR-balanced)` |
| P1 Stability Lock | `P1: Stability Lock â†’ {rep_name} ({lock_type})` |
| Optimization | `Optimized: {rep_name} (geo={score}, cont={score}, team={score})` |

**Highest-Scoring Display**: Even in relaxed mode, the rationale shows which factor scored highest for transparency.

---

## 12. Balancing & Thresholds

> **TL;DR**: Target = Total Ã· Reps. Variance bands: ARR/ATR/Pipeline Â±25% (dashboard) or Â±10-15% (LP solver). Overload = exceeds configured variance (default 20%) from target.

**Impl**: `calculations.ts` - `calculateBalanceTarget()`, `calculateBalanceRange()`
**Constants**: `constants.ts` - `DEFAULT_VARIANCE`, `BATCH_SIZES`, `SUPABASE_LIMITS`

### 12.1 Balance Targets

```typescript
// From calculations.ts
function calculateBalanceTarget(totalValue: number, repCount: number): number {
  if (repCount === 0) return 0;
  return totalValue / repCount;
}
```

### 12.2 Variance Bands

Two systems use different variance bands:

**Dashboard Variance** (`constants.ts` - `DEFAULT_VARIANCE`):
Used for analytics/UI to show acceptable ranges.

| Metric | Variance | Min | Max |
|--------|----------|-----|-----|
| ARR | 25% | Target Ã— 0.75 | Target Ã— 1.25 |
| ATR | 25% | Target Ã— 0.75 | Target Ã— 1.25 |
| Pipeline | 25% | Target Ã— 0.75 | Target Ã— 1.25 |
| Accounts | 15% | Target Ã— 0.85 | Target Ã— 1.15 |
| Tier | 20% | Target Ã— 0.80 | Target Ã— 1.20 |

**LP Solver Variance** (`optimization/types.ts` - `LPBalanceConfig`):
Used by HiGHS solver - intentionally tighter to optimize for balance.

| Metric | Variance | Rationale |
|--------|----------|-----------|
| ARR | 10% | Tighter balance for revenue |
| ATR | 15% | Moderate flexibility for renewals |
| Pipeline | 15% | Moderate flexibility for prospects |

```typescript
// From constants.ts
const DEFAULT_VARIANCE = {
  ARR: 0.25,
  ATR: 0.25,
  PIPELINE: 0.25,
  ACCOUNT_COUNT: 0.15,
  TIER: 0.20,
};
```

> **Configuration Note**: All variance bands and maximum values should come from the assignment configuration step, not be hardcoded. The values above are defaults that can be overridden per-build.

### 12.3 Threshold Overrides

Users can override calculated thresholds in `assignment_configuration`:
- `arr_min_override`, `arr_max_override`
- `atr_min_override`, `atr_max_override`
- `pipeline_min_override`, `pipeline_max_override`

### 12.4 Workload Balance Grades

**Impl**: `utils/workloadBalancing.ts`

The system calculates a composite balance score (0-100) based on ARR, account count, and tier distribution:

| Grade | Score Range | Meaning |
|-------|-------------|---------|
| **Excellent** | 90-100 | Near-perfect distribution |
| **Good** | 75-89 | Acceptable balance |
| **Fair** | 60-74 | Some imbalances detected |
| **Poor** | 40-59 | Significant imbalances |
| **Critical** | 0-39 | Severe imbalances, rebalancing needed |

**Composite Score Formula**:
```
ARR Balance Score    = 100 - (ARR CV Ã— 2)        // CV heavily penalized
Account Balance Score = 100 - (Account CV Ã— 1.5)
Tier Balance Score   = 100 - (Tier CV Ã— 1)

Composite = (ARR Ã— 0.50) + (Account Ã— 0.30) + (Tier Ã— 0.20)
```

Where CV = Coefficient of Variation (std dev / mean Ã— 100)

**Default Workload Config**:
```typescript
{
  arrWeight: 0.50,          // ARR is primary factor
  accountCountWeight: 0.30, // Account distribution secondary
  tierMixWeight: 0.20,      // Tier mix tertiary
  maxARRVariance: 25,       // 25% tolerance
  maxAccountVariance: 15,   // 15% tolerance
}
```

### 12.5 Display Utilities

**Impl**: `calculations.ts` - `formatCurrency()`, `formatCurrencyCompact()`

| Function | Example | Output |
|----------|---------|--------|
| `formatCurrency(1234567)` | Full format | `$1,234,567` |
| `formatCurrencyCompact(1500000)` | Compact | `$1.5M` |
| `formatCurrencyCompact(500000)` | Compact | `$500K` |
| `formatCurrencyCompact(2500000000)` | Compact | `$2.5B` |

---

## 13. Analytics & Success Metrics

**Impl**: `services/optimization/postprocessing/metricsCalculator.ts`, `constants.ts` - `CRE_RISK_THRESHOLDS`, `getCRERiskLevel()`

The app calculates success metrics to measure assignment quality. These are displayed in dashboards.

### 13.1 LP Success Metrics

| Metric | Range | Description |
|--------|-------|-------------|
| **Balance Score** | 0-1 | How evenly ARR/ATR is distributed (MSE-based) |
| **Continuity Score** | 0-1 | % of accounts staying with current owner |
| **Geography Score** | 0-1 | Weighted geo alignment (uses GEO_MATCH_SCORES) |
| **Team Alignment Score** | 0-1 | Account tier matching rep tier |
| **Capacity Utilization** | 0-1+ | Average % of target load per rep |

### 13.2 Balance Score Calculation

> **DEPRECATED**: The MSE-based balance score formula below is deprecated. The app now uses **Coefficient of Variation (CV)** displayed on ARR, ATR, and Pipeline Value charts instead.

```
# DEPRECATED FORMULA - for reference only
BalanceScore = 1 - (MSE / MaxMSE)

Where:
- MSE = Mean Squared Error from target load
- MaxMSE = Theoretical maximum error
- Higher = more balanced
```

**Current Approach**: Each metric chart (ARR, ATR, Pipeline) displays its own CV (standard deviation / mean Ã— 100) for balance assessment.

### 13.3 ARR Distribution Buckets

For histogram visualizations:

| Bucket | Range |
|--------|-------|
| $0-50K | 0 - 50,000 |
| $50K-100K | 50,000 - 100,000 |
| $100K-500K | 100,000 - 500,000 |
| $500K-1M | 500,000 - 1,000,000 |
| $1M+ | 1,000,000+ |

### 13.4 CRE Risk Levels

Customer Renewal risk categorization for dashboard badges:

| Level | CRE Count | Badge Color |
|-------|-----------|-------------|
| None | 0 | Secondary (gray) |
| Low | 1-2 | Outline |
| Medium | 3-5 | Default |
| High | 6+ | Destructive (red) |

```typescript
// From _domain/constants.ts
CRE_RISK_THRESHOLDS = {
  LOW_MAX: 2,    // 1-2 = Low
  MEDIUM_MAX: 5, // 3-5 = Medium
  // 6+ = High
}
```

### 13.5 Balance Threshold Calculator

**Impl**: `services/balanceThresholdCalculator.ts`

Calculates dynamic per-rep targets for additional balance metrics beyond ARR:

| Metric | Calculation | Variance |
|--------|-------------|----------|
| **CRE** | Total CRE count Ã· normal reps | Configurable |
| **ATR** | Total ATR Ã· normal reps | Configurable |
| **Tier 1** | Tier 1 account count Ã· normal reps | Configurable |
| **Tier 2** | Tier 2 account count Ã· normal reps | Configurable |
| **Q1-Q4 Renewals** | Quarterly renewal count Ã· normal reps | renewal_concentration_max |

**Notes**:
- Only **normal reps** (non-strategic, active, with valid region) are included in denominator
- Targets are stored in `assignment_configuration.calculated_thresholds`

### 13.6 Scoring Consistency

**All scoring weights are unified across engine and dashboards:**

| Score Type | Source | Used In |
|------------|--------|---------|
| Geo Match | `_domain/constants.ts` | Engine + Analytics |
| Team Alignment | Section 11.4 formula | Engine + Analytics |
| Continuity | Section 11.4 formula | Engine + Analytics |

The `types/analytics.ts` file imports from `@/_domain` to ensure consistency.

---

# Appendix

## Code Locations

### File â†’ Section Mapping

| File | Key Exports | Doc Section |
|------|-------------|-------------|
| `calculations.ts` | `getAccountARR()`, `getAccountATR()`, `isCustomer()`, `calculateBalanceTarget()` | Â§2, Â§3, Â§12 |
| `tiers.ts` | `classifyTeamTier()`, `TEAM_TIER_ORDER`, `getTierDistance()`, `isEnterprise()` | Â§5 |
| `geography.ts` | `REGION_HIERARCHY`, `REGION_ANCESTRY`, `calculateGeoMatchScore()`, `autoMapTerritoryToUSRegion()` | Â§4 |
| `normalization.ts` | `normalizeRegion()`, `normalizePEFirm()`, `normalizeTeamTier()`, `REGION_ALIASES`, `PE_FIRM_ALIASES` | Â§6 |
| `constants.ts` | `TIER_THRESHOLDS`, `GEO_MATCH_SCORES`, `DEFAULT_VARIANCE`, `BATCH_SIZES`, `DEFAULT_OPTIMIZATION_WEIGHTS` | Â§4, Â§5, Â§9, Â§11, Â§12 |

### External Dependencies

| File | Key Exports | Doc Section |
|------|-------------|-------------|
| `utils/approvalChainUtils.ts` | `getApprovalStepsForRegion()` | Â§7 |
| `utils/autoMappingUtils.ts` | `autoMapFields()`, `ACCOUNT_FIELD_ALIASES`, `SALES_REP_FIELD_ALIASES` | Â§9.5 |
| `config/priorityRegistry.ts` | `PRIORITY_REGISTRY`, `getDefaultPriorityConfig()` | Â§10 |
| `services/simplifiedAssignmentEngine.ts` | Priority waterfall execution | Â§10 |
| `services/optimization/` | LP solver, scoring functions | Â§11 |

**Import Path**: Always use `@/_domain` (configured in `tsconfig.json`)

---

## Cross-Reference System

Every function/constant in `_domain/*.ts` links back to this doc, and vice versa:

| Direction | Format | Example |
|-----------|--------|---------|
| Code â†’ Doc | `@see MASTER_LOGIC.mdc Â§X.X` in JSDoc | `@see MASTER_LOGIC.mdc Â§2.1` |
| Doc â†’ Code | `**Impl**: functionName()` in section | `**Impl**: getAccountARR()` |

> See `_domain/README.md` for the full cross-reference guide.

---

## Maintenance Rules

1. **Add to `_domain/`** - Never add business logic elsewhere
2. **Update this document** - Keep MASTER_LOGIC.mdc in sync
3. **Add cross-references** - Link code â†” doc both directions
4. **Import from `@/_domain`** - All consumers must import

> See `_domain/README.md` for detailed contribution guidelines.
